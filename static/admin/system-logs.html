<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>系统日志</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
  </head>
  <body class="bg-light">
    <div class="container">
      <div class="row justify-content-center mt-5">
        <div class="col-md-10">
          <div class="card">
            <div class="card-body">
              <h3 class="card-title text-center mb-4">
                系统日志
              </h3>
              <div
                id="message-area"
                class="alert d-none"
                role="alert"
              >
              </div>

              <div
                id="logs-list"
                class="mt-4"
                style="overflow-x: auto"
              >
                <!-- Logs will be loaded here -->
              </div>

              <div class="d-grid gap-2 mt-3">
                <a
                  href="/admin/home"
                  class="btn btn-secondary"
                >返回主页</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script>
      const messageArea = document.getElementById("message-area");
      const logsListDiv = document.getElementById("logs-list");

      function displayMessage(message, type) {
        messageArea.textContent = message;
        messageArea.className = `alert alert-${type}`;
        messageArea.classList.remove("d-none");
      }

      function getSystemLogTypeString(type) {
        const types = {
          0: "根用户登录",
          1: "管理员登录",
          2: "学生登录",
          3: "教练登录",
          4: "校区添加",
          5: "管理员添加",
          6: "学生添加",
          7: "学生注册",
          8: "学生移除",
          9: "学生更新",
          10: "学生更改密码",
          11: "学生选择教练",
          12: "学生充值",
          13: "支付完成",
          14: "支付取消",
          15: "学生预约",
          16: "学生取消预约",
          17: "学生批准取消",
          18: "学生评价教练",
          19: "学生请求迁移",
          20: "教练添加",
          21: "教练注册",
          22: "教练批准",
          23: "教练移除",
          24: "教练更新",
          25: "教练更改头像",
          26: "教练更改密码",
          27: "教练批准选择",
          28: "教练拒绝选择",
          29: "教练添加时间段",
          30: "教练批准预约",
          31: "教练拒绝预约",
          32: "教练取消预约",
          33: "教练批准取消",
          34: "教练评价学生",
          35: "球台添加",
          36: "迁移批准",
          37: "迁移完成",
          38: "迁移拒绝",
        };
        return types[type] || "未知";
      }

      async function fetchSystemLogs() {
        try {
          const response = await fetch("/api/admin/system-logs");
          const logs = await response.json();

          if (response.ok) {
            if (logs.length > 0) {
              let logsHtml =
                '<table class="table table-striped"><thead><tr><th>时间戳</th><th>类型</th><th>文本</th><th>相关ID</th><th>校区ID</th></tr></thead><tbody>';
              logs.forEach((log) => {
                const date = new Date(log.timestamp);
                logsHtml += `<tr><td>${date.toLocaleString()}</td><td>${
                  getSystemLogTypeString(log.type)
                }</td><td>${log.text}</td><td>${
                  log.relatedId || "N/A"
                }</td><td>${log.campusId}</td></tr>`;
              });
              logsHtml += "</tbody></table>";
              logsListDiv.innerHTML = logsHtml;
            } else {
              logsListDiv.innerHTML =
                '<p class="text-center">未找到系统日志。</p>';
            }
          } else {
            displayMessage(
              logs.message || "获取系统日志失败。",
              "danger",
            );
          }
        } catch (error) {
          displayMessage(
            "获取系统日志时发生意外错误。",
            "danger",
          );
        }
      }

      fetchSystemLogs();
    </script>
  </body>
</html>
